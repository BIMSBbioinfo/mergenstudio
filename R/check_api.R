#' Check connection to OpenAI's API works
#'
#' This function checks whether the API key provided in the `AI_API_KEY`
#' environment variable is valid.
#'
#' @param api_key An API key.
#' @param verbose Whether to provide information about the API connection
#'
#' @import cli
#' @noRd
check_api_connection <- function(api_key, verbose = FALSE) {
  if (!check_api_key(api_key)) {
    invisible()
  } else {
    status_code <- simple_api_check(api_key)
    if (status_code == 200) {
      if (verbose) {
        cli::cli_alert_success("API key is valid and a simple API call worked.")
        cli::cli_alert_info("The API is validated once per session.")
        cli::cli_text("The default value for number of tokens per query is 500.
                    This equates to approximately $0.01 USD per query. You can
                    increase or decrease the number of tokens with the
                    `mergenstudio.max_tokens` option. Here is an example to lower
                    the max tokens to 100 tokens per query:")
        cli::cli_code("options(\"mergenstudio.max_tokens\" = 100)")
        options("mergenstudio.valid_api" = TRUE)
        options("mergenstudio.openai_key" = api_key)
      }
      invisible(TRUE)
    } else {
      cli::cli_alert_danger("API key found but call was unsuccessful.")
      cli::cli_alert_info("Attempted to use API key: {obscure_key(api_key)}")
      if (interactive()) {
        cli::cli_inform("Satus code: {status_code}")
      } else {
        invisible(FALSE)
      }
    }
  }
}

#' Check API key
#'
#' This function checks whether the API key provided as an argument is in the
#' correct format.
#'
#' @param api_key An API key.
#'
#' @import cli
#' @importFrom stringr str_detect
#' @noRd
check_api_key <- function(api_key) {
  key_instructions <-
    c(
      "!" = "AI_API_KEY is not valid.",
      "i" = "Generate a key at {.url https://platform.openai.com/account/api-keys}",
      "i" = "Set the key in your .Renviron file {.run usethis::edit_r_environ()}"
    )

  if (is.null(api_key)) {
    cli::cli_inform(key_instructions)
    invisible(FALSE)
  }

  if (stringr::str_detect(api_key, "^([a-zA-Z0-9]|-){30,60}$")) {
    invisible(TRUE)
  } else {
    cli::cli_inform(key_instructions)
    invisible(FALSE)
  }
}

#' Check API setup
#'
#' This function checks whether the API key provided in the `AI_API_KEY`
#' environment variable is valid. This function will not re-check an API if it
#' has already been validated in the current session.
#'
#' @import cli
#' @noRd
check_api <- function() {
  api_key <- Sys.getenv("AI_API_KEY")
  valid_api <- getOption("mergenstudio.valid_api")
  saved_key <- getOption("mergenstudio.openai_key")
  if (!valid_api) {
    check_api_connection(api_key)
  } else if (saved_key == Sys.getenv("AI_API_KEY")) {
    invisible(TRUE)
  } else {
    cli::cli_alert_warning("API key has changed. Re-checking API connection.")
    check_api_connection(api_key)
  }
}

#' @importFrom httr2 req_error req_perform resp_status
#' @noRd
simple_api_check <- function(api_key = Sys.getenv("AI_API_KEY")) {
  request_base(task = "models", token = api_key) %>%
    httr2::req_error(is_error = function(resp) FALSE) %>%
    httr2::req_perform() %>%
    httr2::resp_status()
}

obscure_key <- function(api_key) {
  if (nchar(api_key) == 0) {
    "no key provided"
  } else if (nchar(api_key) > 8) {
    api_start <- substr(api_key, 1, 4)
    api_mid <- paste0(rep("*", nchar(api_key) - 8), collapse = "")
    api_end <- substr(api_key, nchar(api_key) - 3, nchar(api_key))
    paste0(api_start, api_mid, api_end)
  } else {
    "<hidden> (too short to obscure)"
  }
}
